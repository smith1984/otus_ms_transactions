# Выпускной проект по курсу [otus microservices](https://otus.ru/lessons/microservice-architecture/)

## Зависимости

Для выполнения задания использовались следующие зависимости:

- [Minikube 1.29.0](https://github.com/kubernetes/minikube/releases/tag/v1.29.0) или [yandex cloud](https://cloud.yandex.ru/)
- [Kubectl 0.26.1](https://github.com/kubernetes/kubectl/releases/tag/v0.26.1)
- [Heml 3.3.4](https://github.com/helm/helm/releases/tag/v3.3.4)


## Описание
### Распределённые транзакции

Реализация распределённых транзакции с использованием паттерна Сага с оркестратором

Реализованы следующие сервисы "Заказ", "Платеж", "Склад", "Доставка"
Для сервиса "Заказ", в рамках метода "создание заказа" происходит вызов оркестратора, которые запускает запросы к связанным сервисам
1. Сервис "Платеж" выполняет оплату товара 
2. Сервис "Склад" резервирует товар 
3. Сервис "Доставка" резервирует доставку на определённое время
    
Если хотя бы от одного из сервисов приходит не успешный результат, то происходит откат всех успешных событий и заказ переходит в статус отменён.

### Асинхронное взаимодействие

Для асинхронного взаимодействия выбрано решение потоковой обработки событий.

Добавлены сервисы "Пользователь", "Биллинг", "Нотификация"
1. Сервис "Пользователь" управляет пользователями интернет-магазина
2. Сервис "Биллинг" отвечает за кошелек пользователя (пополнение, оплата товара)
3. Сервис "Нотификация" отправляет сообщение об статусе операции в биллинге

При проведении операции связанной с оплатой товара, транзакция отправляется в kafka используя механизм CDC и технологию debezium, 
сервис нотификации читает топик кафка и производит нотификацию пользователя (используется заглушка в виде сохранения сообщения в БД)

### Мониторинг системы

Реализованы системы:
1. сбора метрик - Prometheus + Grafana
2. логирования - Opensearch + fluent bit + logback

## Разворачивание инфраструктуры и сервисов
Выполнить
> sh ./install.sh

## Тестирование распределённой транзакции
> newman run ./hw_transactions_postman_collection.json

## Тестирование потоковой обработки
> newman run ./hw_streaming_postman_collection.json

## Тестирование мониторинга
> k6 run --vus 100 --duration 1m --insecure-skip-tls-verify ./k6/script.js -e DOMAIN=arch.homework -e PATH=/user/user/${USER_ID}

## Удаление инфраструктуры и сервисов
> sh ./delete.sh